from capstone_nlp_model import Capstone_NLP_Model
import spacy
import tensorflow as tf
from tensorflow.keras.preprocessing.text import Tokenizer
from tensorflow.keras.preprocessing.sequence import pad_sequences
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Embedding, LSTM, Dense
import numpy as np

def predict_next_word(incomplete_sentence, tokenizer, model, max_len):
    sequence = tokenizer.texts_to_sequences([incomplete_sentence])[0]
    padded_sequence = pad_sequences([sequence], maxlen=max_len, padding='pre')
    pred_id = np.argmax(model.predict(padded_sequence), axis=-1)[0]
    
    return tokenizer.index_word.get(pred_id, "<UNK>")

def main():

    practice_string = "M-137 was a state trunkline highway in the US state of Michigan that served as a spur route to the Interlochen Center for the Arts and Interlochen State Park. It started south of the park and ran north between two lakes in the area and through the community of Interlochen to US Highway 31 (US 31) in Grand Traverse County. The highway was first shown without a number label on maps in 1930 and labeled after an extension the next year. The highways current routing was established in the 1950s. Jurisdiction of the roadway was transferred from the Michigan Department of Transportation (MDOT) to the Grand Traverse County Road Commission in June 2020, and the highway designation was decommissioned in the process; signage was removed by August 2020 to reflect the changeover.  M-137 began at the southern end of Interlochen State Park at an intersection with Vagabond Lane. Farther south, the roadway continues toward Green Lake Airport as County Road 137 (CR 137), also known as Karlin Road. The state highway was a two-lane road that meandered north, passing the entrance to the state park and near the Interlochen Center for the Arts. The road continued along the isthmus between Green and Duck lakes. North of the school, the highway passed through a wooded section before entering the community of Interlochen itself near the Green Lake Township Hall. There M-137 ran almost due north before terminating at its connection with the rest of the state trunkline system at US 31 at Interlochen Corners. The roadway continues north of US 31 as South Long Lake Road after the M-137 designation ended. M-137 was maintained by MDOT like other state highways in Michigan. According to the department in 2010, 4,868 vehicles used the highway daily on average. No section of M-137 had been listed on the National Highway System, a network of roads important to the countrys economy, defense, and mobility.  reassurance marker near Diamond Park Road and the entrance to Interlochen Center for the Arts, May 2018 A highway along the route of M-137 connecting US 31 south to the state park was added to the state highway system during the first half of 1930, initially lacking a designation label on the state maps of the time. This routing was extended by and labelled as M-137 on maps in 1931. The former route through the campus of the Interlochen Center for the Arts was abandoned as a roadway on March 26, 1956, after M-137 was realigned to pass to the east of the school and extended further south through the state park area. On April 30, 2020, the GRCTC was to vote on a resolution to accept jurisdiction over M-137 from MDOT, effective June 1, 2020; the board approved the resolution. MDOT announced on August 6, 2020, that jurisdiction had been transferred at the beginning of June and that all M-137 signage had since been removed.      Former M-137 at Michigan Highways 137 In sociology, dynamic density refers to the combination of two things: population density and the amount of social interaction within that population. Émile Durkheim used the term to explain why societies transition from simple to more complex forms, specifically in terms of the division of labor within that society. He suggested that it required both an increase in population and an increase in the frequency of social interaction to form more specialised occupations, which then leads to a new type of society. People in this new type of society are less independent and more reliant on each other and therefore develop what he called organic solidarity, where people no longer are bound by the same morality and sense of purpose. Critics suggest that it is not a testable hypothesis, and nor does it follow logically that dynamic density would cause this new type of solidarity, supposing it actually existed.  Dynamic density is a key component in Emile Durkheims theory of modernization. In his book The Division of Labor in Society ([1893] 1949), Durkheim suggests that over time, societies go through a transition from being more primitive, i.e. mechanical, to being more modern, or organic; the difference lying in the source of their solidarity, or what holds them together. (Ritzer, 2007) According to Durkheim, the cause of this transition is an increase in dynamic density, an idea he drew from earlier sociologists. Already Adam Smith had pointed to sufficient demand as a necessary condition for specialization, and Durkheim himself refers to Comte for the idea that density of interaction is the decisive factor [for transition to occur]. (Rueschemeyer, 1982:580) Durkheim also borrows from Darwinian theory, and specifically from Darwins The Origin of Species, for his explanation.(Rueschemeyer, 1982) In the animal kingdom, a single species of animal, like sheep, cannot survive in very high volumes on a given stretch of land because each animal makes exactly the same demands on that land. (Gibbs, 2003) They need to exist in symbiosis with other species, like the bees that fertilize the plants they consume, in order to thrive in greater numbers. (Gibbs, 2003) The same holds true within a human population. Had primitive societies increased in population density for many generations without an eventual specialization of tasks, competition for resources among the increasing number of people would have become so fierce that humans would have started dying off. (Merton, 1994) However, a growing population alone is not sufficient to spark a change in the division of labor, because individuals and small groups of people can live in relative isolation from one another and still perform most of the tasks necessary for survival themselves, no matter how big the overall population gets. (Ritzer, 2007) A growing population must also increase the frequency with which people interact within and between social groups; this increase in dynamic density is likely to spark a division of labor and the transformation of social solidarity. There are two types of social solidarity. The first is mechanical solidarity, where people are held together because they all serve the same purpose, or do the same things (as in a hunter-gatherer society), and their collective consciousness is therefore very strong. The people are all self-reliant, but they share the same experiences, understandings, and core beliefs, and can relate in that way. The second type of solidarity, organic solidarity, is the result of a substantial division of labor that has occurred due to much growth of dynamic density. People in organic solidarity have more specialized skills, so individuals are no longer self-sustaining. An example of this is that a philosopher has neither the time nor the ability to grow his own food, and so he is dependent upon a farmer and various other individuals so he can eat. In this situation, solidarity in society comes from the fact that people need the contribution of an increasing number of other people in order to function, and even to survive. (Ritzer, 2007) The transition from one type of solidarity to another is readily apparent in history when looking at societal changes from repressive law systems to restitutive law systems. A repressive law system is one in which any law breaker is severely punished for their crimes. This type of law exists in mechanical solidarity because the laws are based on the very powerful collective conscience, or set of social norms, that the people in a mechanical society all strongly believe in. Any violation of these beliefs is seen as an extreme offense against society as a whole. In contrast, a restitutive law system is characteristic of organic solidarity. Restitutive laws require an offender to pay for the harm he did to whoever was affected by his crimes, or he is just asked to comply with the law. With the growth of dynamic density and resulting division of labor in society, collective consciousness is weakened severely and people no longer have a unified sense of morality. (Muller, 1994) Everyone is no longer affected by or connected to every deviant action that takes place in society in organic solidarity, so the call for severity no longer exists.  There are some who disagree with Durkheims theory that dynamic density is the cause of social transition. Robert K. Merton argues that Durkheim has no empirical evidence supporting a link between dynamic density and a change from mechanical to organic solidarity. He says that Durkheim seeks to ignore the role that social driven ends themselves play into how society interacts. (Merton, 1994) Jack Gibbs also says that Durkheims theory of dynamic density leading to the division of labor is not scientifically testable for or evident of causality, arguing that there is no feasible way to measure the frequency of interactions between people, and thus no way to track progress or growth of said frequency; without these measurements, it is impossible to prove any correlation to division of labor. (Gibbs, 2003) Dietrich Rueschemeyer argues from an economics perspective that competition in production, which is the basis for a free market system, does not have the same consequences as Darwinian competition. (Rueschemeyer, 1982) To him, it follows logically that increased demand due to increased population density, for a product such as corn in an agrarian society, would improve rather than diminish the producers chances of survival. (Rueschemeyer, 1982) Hence, it does not follow logically that dynamic density would cause the transition from mechanical to organic solidarity.   Interaction frequency   Ritzer, George (2007)Contemporary Sociological Theory and Its Classical Roots; The Basics McGraw Hill  Merton, Robert K. (1994) Durkheims Division of Labor in Society Plenum Press, NY and London Sociological Forum, Vol. 9, No. 1  Muller, Hans-Peter (1994) Social DIfferentiation and Organic Solidarity: The Division of Labor Revisited Plenum Press, NY and London Sociological Forum, Vol. 9, No. 1  Gibbs, Jack P. (2003) A Formal Restatement of Durkheims Division of Labor Theory, Sociological Theory, Vol. 21, No. 2  Rueschemeyer, Dietrich (1982)On Durkheims Explanation of the Division of Labor The American Journal of Sociology, Vol. 88, No. 3   Emile Durkheim on the Division of LaborBert Robert Shepard (June 20, 1920 – June 16, 2008) was an American left- handed pitcher in Major League Baseball who pitched in one game for the Washington Senators in 1945 after having had his right leg amputated after his fighter plane was shot down in Germany during World War II while he was serving as a pilot in the Army Air Forces.Milestones: Bert Shephard, July 7, 2008, TIME Magazine, p. 18  Born in Dana, Indiana, the 511, 185 lb. left-hander taught himself to walk and then to pitch with an artificial leg while confined in the German POW camp Stalag IX C(b) in city Meiningen.Baseball in Wartime, When Baseball Went to War. Society for American Baseball Research, 55th Fighter Group Association The Canadian doctor and prisoner Doug Errey produced the prosthesis for Bert. Shepard had been gunned down east of Hamburg on his 34th mission as a P-38 fighter pilot; his life was saved by the doctor Lieutenant Ladislaus Loidl of the German Army. On February 21, 1945, Shepard was back in the United States and hoping to resume his pitching career. Prior to the war, he had pitched for minor leagues all across the country, including the Anaheim Aces in 1941. During spring training in 1945, he impressed Senators owner Clark Griffith enough to be hired as a pitching coach. He pitched exhibition games and batting practice as well as one regulation game, making him the first man with an artificial leg to pitch in a major league baseball game. On August 4, 1945 Shepard got the call to enter in the fourth inning of a home game in which the Senators were well behind the Boston Red Sox. It was game two of Washingtons fourth consecutive doubleheader, with a fifth scheduled the next day as well. Shepard made headlines not only for being in the game itself, but also for his 5⅓ innings of impressive relief, allowing only three hits and one run. He struck out the first batter he faced. The final score was Red Sox 15, Senators 4.Weintraub, Robert (2013) The Victory Season: The End of World War II and the Birth of Baseballs Golden Age. New York: Little Brown and Company, pages 137-138 The game of August 4, 1945 was notable for two other events as well. Shepard came in to relieve teammate Joe Cleary, whose surrender of seven runs on five hits and three walks in one-third of an inning in his only big-league appearance earned him the highest lifetime ERA — 189.00 — of any pitcher in Major League Baseball history to have recorded at least one out. Also, outfielder Tom McBride tied a major league record with 6 runs batted in in the fourth inning, which was pitched by Cleary. In between games of a doubleheader on August 31, Shepard received the Distinguished Flying Cross and the Air Medal for his service in World War II. He later went on to be a player/manager in the minor leagues until 1954. He was a key participant in the National Amps baseball teams of former servicemen with amputations secondary to war injuries. After retiring from baseball, Shepard worked for IBM and Hughes Aircraft as a safety engineer. Shepard won the U.S. amputee golf championship in 1968 and 1971. Shepard died at age 87 in Highland, California. He was buried at Riverside National Cemetery in Riverside, California.Baseballs Greatest Sacrifice   Dennis Snelling: A Glimpse of Fame, McFarland & Company, Jefferson N.C., 1993, pp. 115–134 Richard Tellis: Once Around The Bases, Triumph Books, Chicago, 1998, pp. 107–120.  Baseball in Wartime BaseballLibrary – biography & photograph BaseballLibrary – Once Around the Bases Baseball Guru – Bert Shepard and the Missing Foot New York Times obituary, June 19, 2008"

    nlp = spacy.load('en_core_web_sm')
    capstone_nlp = Capstone_NLP_Model()

    doc = nlp(practice_string)

    capstone_nlp.create_list_of_tokenized_sentences(doc)
    capstone_nlp.create_list_of_sentence_training_arrays()
    #print(capstone_nlp.list_of_training_arrays_strings)

    tf_tokenizer = Tokenizer(lower=False, oov_token="<OOV>")  # lower=False preserves casing
    tf_tokenizer.fit_on_texts(capstone_nlp.list_of_training_arrays_strings)

    capstone_nlp.list_of_training_arrays_ids = tf_tokenizer.texts_to_sequences(capstone_nlp.list_of_training_arrays_strings)

    list_of_inputs = []
    list_of_labels = []
    for training_array in capstone_nlp.list_of_training_arrays_ids:
        if len(training_array) < 2:
            continue  # Skip sequences that are too short to split
        list_of_inputs.append(training_array[:-1])
        list_of_labels.append(training_array[-1])

    padded_inputs = pad_sequences(list_of_inputs, padding='pre', maxlen=capstone_nlp.MAX_ALLOWED_TOKENS_IN_A_SENTENCE - 1, dtype='int32')


    labels = np.array(list_of_labels, dtype=np.int32)


    capstone_nlp.list_of_training_inputs = padded_inputs
    capstone_nlp.list_of_training_labels = labels

    vocab_size = len(tf_tokenizer.word_index) + 1
    capstone_nlp.model = Sequential()   # Sequential model is a good choice because my model is simple with a single input.
                                        # Each layer can transform the data and output it as the input to the next layer.

    capstone_nlp.model.add(Embedding(input_dim=vocab_size, output_dim=capstone_nlp.OUTPUT_DIMENSION_SIZE_64))
    capstone_nlp.model.add(LSTM(capstone_nlp.OUTPUT_DIMENSION_SIZE_64))
    capstone_nlp.model.add(Dense(vocab_size, activation='softmax'))

    capstone_nlp.model.compile(loss='sparse_categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
    #capstone_nlp.model.summary()
    capstone_nlp.model.fit(padded_inputs, capstone_nlp.list_of_training_labels, epochs=30, verbose=1)

    user_sentence = input("Enter half a sentence: ")
    in_generating_mode = True
    while in_generating_mode:
        next_word = predict_next_word(user_sentence, tf_tokenizer, capstone_nlp.model, capstone_nlp.MAX_ALLOWED_TOKENS_IN_A_SENTENCE)
        user_sentence = user_sentence + " " + next_word
        print(user_sentence)
        keep_generating = input("Keep generating type '.'")
        if keep_generating != ".":
            in_generating_mode = False

main()